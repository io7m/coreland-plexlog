#!/bin/sh

dir="testdata/log"

cleanup()
{
  rm -r "$dir"
}

die()
{
  echo "fatal: $1" 1>&2
  cleanup
  exit 1
}

makedir()
{
  echo "mkdir $1"
  mkdir "$1" || die "could not create $1"
}

exists()
{
  if [ ! -f "$dir/$1" ]; then die "$dir/$1 does not exist"; fi
}

nonexistent()
{
  if [ -f "$dir/$1" ]; then die "$dir/$1 exists"; fi
}

log()
{
  echo "log $1 $2"
  ./write "$1" "$2" | ./log "$dir" 0 1024 || die "could not write log"
}

check_num()
{
  val=`grep "$1" "$dir"/* | wc -l`
  if [ $val -ne $2 ]; then die "expected $2 written lines of $1, got $val"; fi
}

makedir "$dir"

log 256 "AAAA"
log 256 "BBBB"
log 256 "CCCC"
log 256 "DDDD"

check_num "AAAA" 256
check_num "BBBB" 256
check_num "CCCC" 256
check_num "DDDD" 256

exists "current"

cleanup
